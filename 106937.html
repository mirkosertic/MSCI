<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="chart.js"></script>
        <script src="statistics.min.js"></script>
        <title>106937 MSCI Daily TR World Net Household Durablesm (EUR/NETR) Visualization. USE AT YOUR OWN RISK! 20181010 to 20221009</title>
        <script>
            function fetchJSON(res, func) {
                fetch(res, {cache: 'no-cache'}).then(function(response) {return response.json()}).then(func);
            }

            function movingAverage(windowSize, data, datakey) {
                const result = [];
                const currentwindow = []

                average = arr => arr.reduce( ( p, c ) => p + c, 0 ) / arr.length;

                for (var i = 0; i < data.length; i++) {
                    const datapoint = data[i];
                    if (currentwindow.length < windowSize) {
                        currentwindow.push(datapoint[datakey]);
                        const sma = {
                            calc_date: datapoint.calc_date
                        };
                        sma[datakey] = null;
                        result.push(sma);
                    } else {
                        currentwindow.shift();
                        currentwindow.push(datapoint[datakey]);
                        const sma = {
                            calc_date: datapoint.calc_date
                        };
                        sma[datakey] = average(currentwindow);
                        result.push(sma);
                    }
                }
                return result;
            }
        </script>
    </head>
    <body>
        <canvas id="chart_visualization"></canvas>
        <table id="correlations">
            <tr>
                <td>ID</td>
                <th>Name</th>
                <th>Pearson's correlation</th>
                <th>Perf. 3 Months</th>
                <th>Perf. 6 Months</th>
                <th>Perf. 1 Year</th>
                <th>Perf. 2 Years</th>
                <th>Perf. 3 Years</th>
            </tr>
        </table>
        <script>
            fetchJSON('stockdata.json', function(stock) {

                var stockvalues = stock.levels;

                var bodyVars = {
                    '106937': 'metric',
                };

                var keys = Object.keys(stock.stocks);
                var correlations = [];
                for (var i = 0; i < keys.length; i++) {
                    var id = keys[i];
                    if ('level_eod' !== id) {
                        bodyVars[id] = 'metric';

                        var stats = new Statistics(stockvalues, bodyVars);
                        var r = stats.correlationCoefficient('106937', id);
                        if (r) {
                            correlations.push({
                                id: id,
                                stock: stock.stocks[id],
                                correlationCoefficient: r.correlationCoefficient
                            });
                        }
                    }
                }

                correlations.sort(function(a, b) {
                    if (a.correlationCoefficient < b.correlationCoefficient) {
                        return 1;
                    }
                    if (a.correlationCoefficient > b.correlationCoefficient) {
                        return -1;
                    }
                    return 0;
                });


                for (var i = 0; i < correlations.length; i++) {
                    var correlation = correlations[i];
                    var row = document.getElementById('correlations').insertRow(-1);
                    var cell1 = row.insertCell(0);
                    cell1.innerHTML = '<a href="' + correlation.id + '.html">' + correlation.id + '</a>';
                    var cell2 = row.insertCell(1);
                    cell2.innerHTML = correlation.stock.name;
                    var cell3 = row.insertCell(2);
                    cell3.innerHTML = correlation.correlationCoefficient.toFixed(4);

                    if (correlation.stock.stats_90days) {
                        var cell4 = row.insertCell(3);
                        cell4.innerHTML = correlation.stock.stats_90days.performance;
                    }
                    if (correlation.stock.stats_180days) {
                        var cell5 = row.insertCell(4);
                        cell5.innerHTML = correlation.stock.stats_180days.performance;
                    }
                    if (correlation.stock.stats_365days) {
                        var cell6 = row.insertCell(5);
                        cell6.innerHTML = correlation.stock.stats_365days.performance;
                    }
                    if (correlation.stock.stats_730days) {
                        var cell7 = row.insertCell(6);
                        cell7.innerHTML = correlation.stock.stats_730days.performance;
                    }
                    if (correlation.stock.stats_1095days) {
                        var cell8 = row.insertCell(7);
                        cell8.innerHTML = correlation.stock.stats_1095days.performance;
                    }
                }

                const data = {
                    labels: stockvalues.map(a => a.calc_date),
                    datasets: [{
                        label: '106937 MSCI Daily TR World Net Household Durablesm (EUR/NETR) (USE AT YOUR OWN RISK!) 20181010 to 20221009',
                        backgroundColor: '#2c3e50',
                        borderColor: '#2c3e50',
                        data: stockvalues,
                        parsing: {
                            xAxisKey: 'calc_date',
                            yAxisKey: '106937'
                        },
                        pointRadius: 0
                    }, {
                        label: 'Moving Average 200 days',
                        backgroundColor: '#16a085',
                        borderColor: '#16a085',
                        data: movingAverage(200, stockvalues, '106937'),
                        parsing: {
                            xAxisKey: 'calc_date',
                            yAxisKey: '106937'
                        },
                        pointRadius: 0
                    }, {
                        label: 'Moving Average 37 days',
                        backgroundColor: '#d35400',
                        borderColor: '#d35400',
                        data: movingAverage(37, stockvalues, '106937'),
                        parsing: {
                            xAxisKey: 'calc_date',
                            yAxisKey: '106937'
                        },
                        pointRadius: 0
                    }]
                };

                const config = {
                    type: 'line',
                    data: data,
                    options: {
                        animation: false
                    },
                    plugins: []
                };

                const c = new Chart(document.getElementById('chart_visualization'), config);
            });
        </script>
    </body>
</html>