<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="chart.js"></script>
        <script src="statistics.min.js"></script>
        <title>107054 MSCI Daily TR World Net Transportation Infrastructure (EUR/NETR) Visualization. USE AT YOUR OWN RISK! 20181007 to 20221006</title>
        <script>
            function fetchJSON(res, func) {
                fetch(res, {cache: 'no-cache'}).then(function(response) {return response.json()}).then(func);
            }

            function movingAverage(windowSize, data, datakey) {
                const result = [];
                const currentwindow = []

                average = arr => arr.reduce( ( p, c ) => p + c, 0 ) / arr.length;

                for (var i = 0; i < data.length; i++) {
                    const datapoint = data[i];
                    if (currentwindow.length < windowSize) {
                        currentwindow.push(datapoint[datakey]);
                        const sma = {
                            calc_date: datapoint.calc_date
                        };
                        sma[datakey] = null;
                        result.push(sma);
                    } else {
                        currentwindow.shift();
                        currentwindow.push(datapoint[datakey]);
                        const sma = {
                            calc_date: datapoint.calc_date
                        };
                        sma[datakey] = average(currentwindow);
                        result.push(sma);
                    }
                }
                return result;
            }
        </script>
    </head>
    <body>
        <canvas id="chart_visualization"></canvas>
        <table id="correlations">
            <tr>
                <td>ID</td>
                <th>Name</th>
                <th>Pearson's correlation</th>
            </tr>
        </table>
        <script>
            fetchJSON('stockdata.json', function(stock) {

                var stockvalues = stock.levels;

                var bodyVars = {
                    '107054': 'metric',
                };

                var keys = Object.keys(stock.stocks);
                var correlations = [];
                for (var i = 0; i < keys.length; i++) {
                    var id = keys[i];
                    if ('level_eod' !== id) {
                        bodyVars[id] = 'metric';

                        var stats = new Statistics(stockvalues, bodyVars);
                        var r = stats.correlationCoefficient('107054', id);
                        if (r) {
                            correlations.push({
                                id: id,
                                name: stock.stocks[id].name,
                                correlationCoefficient: r.correlationCoefficient
                            });
                        }
                    }
                }

                correlations.sort(function(a, b) {
                    if (a.correlationCoefficient < b.correlationCoefficient) {
                        return 1;
                    }
                    if (a.correlationCoefficient > b.correlationCoefficient) {
                        return -1;
                    }
                    return 0;
                });

                for (var i = 0; i < correlations.length; i++) {
                    var correlation = correlations[i];
                    var row = document.getElementById('correlations').insertRow(-1);
                    var cell1 = row.insertCell(0);
                    cell1.innerHTML = correlation.id;
                    var cell2 = row.insertCell(1);
                    cell2.innerHTML = correlation.name;
                    var cell3 = row.insertCell(2);
                    cell3.innerHTML = correlation.correlationCoefficient;
                }

                const data = {
                    labels: stockvalues.map(a => a.calc_date),
                    datasets: [{
                        label: '107054 MSCI Daily TR World Net Transportation Infrastructure (EUR/NETR) (USE AT YOUR OWN RISK!) 20181007 to 20221006',
                        backgroundColor: '#2c3e50',
                        borderColor: '#2c3e50',
                        data: stockvalues,
                        parsing: {
                            xAxisKey: 'calc_date',
                            yAxisKey: '107054'
                        },
                        pointRadius: 0
                    }, {
                        label: 'Moving Average 200 days',
                        backgroundColor: '#16a085',
                        borderColor: '#16a085',
                        data: movingAverage(200, stockvalues, '107054'),
                        parsing: {
                            xAxisKey: 'calc_date',
                            yAxisKey: '107054'
                        },
                        pointRadius: 0
                    }, {
                        label: 'Moving Average 37 days',
                        backgroundColor: '#d35400',
                        borderColor: '#d35400',
                        data: movingAverage(37, stockvalues, '107054'),
                        parsing: {
                            xAxisKey: 'calc_date',
                            yAxisKey: '107054'
                        },
                        pointRadius: 0
                    }]
                };

                const config = {
                    type: 'line',
                    data: data,
                    options: {
                        animation: false
                    },
                    plugins: []
                };

                const c = new Chart(document.getElementById('chart_visualization'), config);
            });
        </script>
    </body>
</html>